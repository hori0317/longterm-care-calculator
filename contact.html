<script>
(function(){
  // ＝＝＝＝＝＝＝＝＝＝ 工具：顯示錯誤 / 偵錯資訊 ＝＝＝＝＝＝＝＝＝＝
  function ensureDebugArea(){
    let box = document.getElementById('ps-debug');
    if (box) return box;
    box = document.createElement('div');
    box.id = 'ps-debug';
    box.style.cssText = 'margin-top:12px;padding:10px;border:1px dashed #c7d3ee;background:#f9fbff;border-radius:8px;font-size:12px;white-space:pre-wrap;color:#102a56';
    box.innerHTML = '偵錯訊息將顯示於此（僅你看得到）：\n';
    const wrap = document.querySelector('#pdf-stat .pdfstat-wrap');
    wrap && wrap.appendChild(box);
    return box;
  }
  function logDebug(msg){
    console.log('[pdf-stat]', msg);
    const box = ensureDebugArea();
    box.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
  }
  function showAlert(msg){
    alert(msg);
    logDebug('⚠ ' + msg);
  }

  // ＝＝＝＝＝＝＝＝＝＝ DOM 參照 ＝＝＝＝＝＝＝＝＝＝
  const fileInput = document.getElementById('ps-file');
  const drop = document.getElementById('ps-drop');
  const demoBtn = document.getElementById('ps-demo');

  const tbl = {
    BA: document.querySelector('#ps-ba tbody'),
    AA: document.querySelector('#ps-aa tbody'),
    GA: document.querySelector('#ps-ga tbody'),
    SC: document.querySelector('#ps-sc tbody'),
  };

  // ＝＝＝＝＝＝＝＝＝＝ AA 單價（僅 AA 用；GA/SC 不換算） ＝＝＝＝＝＝＝＝＝＝
  function getPriceMap(){
    return {
      AA05: Number(document.getElementById('ps-price-AA05')?.value||100),
      AA06: Number(document.getElementById('ps-price-AA06')?.value||200),
      AA09: Number(document.getElementById('ps-price-AA09')?.value||770),
      AA11: Number(document.getElementById('ps-price-AA11')?.value||50),
    };
  }

  // ＝＝＝＝＝＝＝＝＝＝ 核心：讀取 PDF 文字（強化版） ＝＝＝＝＝＝＝＝＝＝
  async function extractPdfText(file){
    await ensurePdfjs(); // ← 一定要等載入完成
    try{
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({
        data: arrayBuffer,
        // 某些 PDF 有奇怪字型，以下選項可提升擷取穩定度
        standardFontDataUrl: undefined
      }).promise;

      let texts = [];
      let totalChars = 0;

      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent({
          normalizeWhitespace: true,        // 正規化空白
          disableCombineTextItems: false    // 讓 pdf.js 自動合併片段
        });
        const pageText = content.items.map(it=>it.str || '').join(' ');
        totalChars += pageText.length;
        texts.push(pageText);
      }

      logDebug(`已讀取頁數：${pdf.numPages}；總字元數：${totalChars}`);
      if (pdf.numPages > 0){
        const preview = texts[0].slice(0, 200).replace(/\s+/g,' ');
        logDebug(`第 1 頁前 200 字預覽：\n${preview}`);
      }

      if (totalChars === 0){
        showAlert('檔內沒有可擷取的文字（很可能是掃描影像 PDF）。請先做 OCR 後再上傳。');
      }
      return texts.join('\n');
    }catch(err){
      console.error(err);
      showAlert('無法讀取 PDF：可能是受保護或檔案損毀。');
      throw err;
    }
  }

  // ＝＝＝＝＝＝＝＝＝＝ 解析四大類（支數） ＝＝＝＝＝＝＝＝＝＝
  function analyze(text){
    const priceMap = getPriceMap();
    const families = {BA:{}, AA:{}, GA:{}, SC:{}};
    const lines = text.split(/\r?\n/);
    const codeRe = /\b(BA|AA|GA|SC)\d{2}(?:-\d+)?\b/g;

    for(const raw of lines){
      const line = raw.trim();
      if(!line) continue;

      const matches = [...line.matchAll(codeRe)];
      if (!matches.length) continue;

      for(const m of matches){
        const fullCode = m[0];            // 例如 BA01 / AA05 / GAxx / SCxx
        const fam = fullCode.slice(0,2);  // BA / AA / GA / SC
        const map = families[fam];
        const seg = line.slice(m.index);  // 該碼起算到行尾的片段

        // 1) 次數（補助/自費 後 1~20）
        let count = null;
        const countMatch = seg.match(/(?:補助|自費)\s*([0-9]{1,2})/);
        if (countMatch){
          const v = parseInt(countMatch[1],10);
          if (v >= 1 && v <= 20) count = v;
        }

        // 2) 金額（僅供 AA 無次數時換算）
        let amount = null;
        if (count === null && fam === 'AA'){
          const ints = (seg.match(/\d+/g) || []).map(n=>parseInt(n,10));
          const candidates = ints.filter(n => n >= 30); // 金額常 >= 30
          if (candidates.length){
            amount = candidates[candidates.length - 1]; // 取較靠後的
          }
        }

        // 3) 支數判定
        let zhi = 0;
        if (count !== null){
          zhi = count; // 次數優先
        } else if (fam === 'AA') {
          const unit = priceMap[fullCode] ?? priceMap[fullCode.slice(0,4)];
          if (unit && amount && amount >= Math.floor(unit*0.5)){
            zhi = Math.round((amount / unit) * 1000) / 1000;
          }
        } // BA/GA/SC 沒有次數就 0，不做金額換算

        const rec = map[fullCode] || {occ:0, sum:0};
        rec.occ += 1;
        rec.sum += zhi;
        map[fullCode] = rec;
      }
    }

    function toRows(obj){
      return Object.entries(obj)
        .map(([code, {occ, sum}])=>({code, occ, sum, avg: occ ? (sum/occ) : 0}))
        .sort((a,b)=> a.code.localeCompare(b.code));
    }

    return {
      BA: toRows(families.BA),
      AA: toRows(families.AA),
      GA: toRows(families.GA),
      SC: toRows(families.SC),
    };
  }

  // ＝＝＝＝＝＝＝＝＝＝ 渲染 & 匯出 ＝＝＝＝＝＝＝＝＝＝
  function renderRows(tbody, rows){
    tbody.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td><span class="pdfstat-pill">${r.code}</span></td>
         <td class="pdfstat-right">${r.occ}</td>
         <td class="pdfstat-right">${r.sum.toFixed(3)}</td>
         <td class="pdfstat-right">${r.avg.toFixed(3)}</td>`;
      tbody.appendChild(tr);
    }
  }
  function renderAll(result){
    renderRows(tbl.BA, result.BA);
    renderRows(tbl.AA, result.AA);
    renderRows(tbl.GA, result.GA);
    renderRows(tbl.SC, result.SC);
  }
  function exportCSVAll(result){
    function block(title, rows){
      let s = `${title}\n碼別,出現筆數,Σ支數,平均每筆\n`;
      rows.forEach(r=>{ s += `${r.code},${r.occ},${r.sum.toFixed(3)},${r.avg.toFixed(3)}\n`; });
      s += '\n';
      return s;
    }
    const csv =
      block('【BA 統計】', result.BA) +
      block('【AA 統計】', result.AA) +
      block('【GA 統計】', result.GA) +
      block('【SC 統計】', result.SC);

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'pdf-stat-all.csv'; a.click();
    URL.revokeObjectURL(url);
  }
  function exportJSONAll(result){
    const blob = new Blob([JSON.stringify(result,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'pdf-stat-all.json'; a.click();
    URL.revokeObjectURL(url);
  }

  let last = null;

  async function handleText(text){
    if (!text || !text.trim()){
      showAlert('沒有擷取到文字內容：多半是掃描影像 PDF，請先做 OCR。');
      return;
    }
    const result = analyze(text);
    renderAll(result);
    last = result;
    // 啟用匯出
    ['ps-export-csv','ps-export-json'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.disabled = false;
    });
  }

  // ＝＝＝＝＝＝＝＝＝＝ 事件：選檔 / 拖放 / 匯出 / 示範 ＝＝＝＝＝＝＝＝＝＝
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const isPdf = (f.type === 'application/pdf') || /\.pdf$/i.test(f.name);
    if(!isPdf){ showAlert('請選擇 PDF 檔'); return; }
    logDebug(`開始讀取：${f.name}（type=${f.type||'N/A'} size=${f.size}）`);
    const text = await extractPdfText(f);
    handleText(text);
  });

  ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt, e=>{
    e.preventDefault(); drop.style.background='#eef4ff';
  }));
  ['dragleave','drop'].forEach(evt=>drop.addEventListener(evt, e=>{
    e.preventDefault(); drop.style.background='#f9fbff';
  }));
  drop.addEventListener('drop', async (e)=>{
    e.preventDefault();
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if(file && ((file.type === 'application/pdf') || /\.pdf$/i.test(file.name))){
      logDebug(`拖放：${file.name}（type=${file.type||'N/A'} size=${file.size}）`);
      const text = await extractPdfText(file);
      handleText(text);
    }else{
      showAlert('請拖入 PDF 檔案');
    }
  });

  document.getElementById('ps-export-csv').addEventListener('click', ()=>{ if(last) exportCSVAll(last); });
  document.getElementById('ps-export-json').addEventListener('click', ()=>{ if(last) exportJSONAll(last); });

  demoBtn.addEventListener('click', ()=>{
    const demo = `嚴雅雯范秉殷2025-09-05 5 08:07 ~ 08:42 BA01補助1 260 $
嚴雅雯江昭輝2025-09-01 1 14:25 ~ 14:51 BA07補助1 325 $
嚴雅雯張財進2025-09-02 2 08:18 ~ 08:36 BA11補助1 195 $
嚴雅雯柯水龍2025-09-01 1 15:30 ~ 16:30 BA13補助2 390 $
嚴雅雯賴美女2025/09/01 AA05補助100
嚴雅雯賴美女2025/09/02 AA05補助200
嚴雅雯張財進2025/09/02 AA06補助200
嚴雅雯賴美女2025/09/06 AA09補助770
嚴雅雯江昭輝2025/09/01 AA11補助50`;
    handleText(demo);
  });

  // 頁面載入即建立偵錯面板
  ensureDebugArea();
})();
</script>
