<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF 支數自動統計（含 OCR，多版本 pdf.js 回退）</title>
  <meta name="description" content="上傳 PDF，統計 BA/AA/GA/SC 支數；若為掃描影像自動啟用 OCR（chi_tra+eng）。">

  <style>
    :root{--bg:#f6f8fb;--panel:#fff;--text:#0b1220;--muted:#5b6b81;--accent:#2667ff;--br:16px}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1120px;margin:0 auto;padding:20px 16px 40px}
    .card{background:var(--panel);border:1px solid #e1e6ef;border-radius:var(--br);box-shadow:0 4px 14px rgba(20,40,80,.06);padding:16px;margin:12px 0}
    h1{font-size:1.5rem;margin:.4rem 0}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    @media(min-width:920px){.row{grid-template-columns:1.15fr .85fr}}
    .drop{border:2px dashed #c7d3ee;border-radius:12px;padding:18px;text-align:center;cursor:pointer;background:#f9fbff}
    .drop:hover{background:#eef4ff}
    input[type=file]{display:none}
    .btn{appearance:none;border:1px solid #c7d3ee;background:#f3f6ff;color:#102a56;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{background:#eef3ff;color:#102a56;text-align:left;padding:10px;border-bottom:1px solid #d8e2ff}
    tbody td{padding:10px;border-bottom:1px solid #edf1f7}
    tbody tr:hover{background:#f5f8ff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef4ff;border:1px solid #dbe6ff;font-size:.85rem;color:#102a56}
    .right{text-align:right}
    .small{font-size:.86rem}
    .grid2{display:grid;gap:12px}
    @media(min-width:720px){.grid2{grid-template-columns:1fr 1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    details summary{cursor:pointer;color:#102a56}
    #debug{margin-top:12px;padding:10px;border:1px dashed #c7d3ee;background:#f9fbff;border-radius:8px;font-size:12px;white-space:pre-wrap;color:#102a56}
    .progress{height:10px;background:#eef3ff;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:#2667ff;transition:width .2s}
    .hint{display:inline-block;margin-left:8px;color:#845400}
  </style>

  <!-- 動態載入 PDF.js（4.x → 3.x → 2.x 逐版回退；worker 失敗則同執行緒） -->
  <script>
    let __pdfReady = null;
    let __pdfVersionUsed = null;

    async function loadScript(src){
      await new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load fail '+src));
        document.head.appendChild(s);
      });
    }

    async function tryLoadPdfjs(ver){
      // 清掉舊的全域（避免不同版殘留）
      if (window.pdfjsLib) delete window.pdfjsLib;
      await loadScript(`https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.min.js`);
      __pdfVersionUsed = ver;
      try{
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          `https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.js`;
        // 探針：不是有效 PDF 會 throw，沒關係；主要是測 worker 能否初始化
        await pdfjsLib.getDocument({ data: new Uint8Array([0x25,0x50,0x44,0x46,0x2D]) }).promise.catch(()=>null);
      }catch(e){
        // worker 失敗 → 主執行緒
        pdfjsLib.GlobalWorkerOptions.workerSrc = "";
        pdfjsLib.GlobalWorkerOptions.workerPort = null;
      }
    }

    async function ensurePdfjs(){
      if (__pdfReady){ await __pdfReady; return; }
      __pdfReady = (async ()=>{
        const cand = ["4.2.67","3.11.174","2.16.105"];
        let ok=false, lastErr=null;
        for (const v of cand){
          try{ await tryLoadPdfjs(v); ok=true; break; }catch(e){ lastErr=e; }
        }
        if(!ok) throw lastErr || new Error("pdf.js load failed");
      })();
      await __pdfReady;
    }
  </script>

  <!-- 動態載入 Tesseract.js（前端 OCR） -->
  <script>
    let __ocrReady = null;
    async function ensureTesseract(){
      if (__ocrReady) { await __ocrReady; return; }
      __ocrReady = (async ()=>{
        if (!window.Tesseract){
          await new Promise((res, rej)=>{
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js';
            s.onload = res; s.onerror = rej;
            document.head.appendChild(s);
          });
        }
        Tesseract.setLogging(false);
      })();
      await __ocrReady;
    }
  </script>
</head>
<body>
  <div class="wrap">
    <h1>PDF 支數自動統計（含 OCR）</h1>
    <p class="muted">
      上傳報表，秒統計 <span class="pill">BA</span> / <span class="pill">AA</span> / <span class="pill">GA</span> / <span class="pill">SC</span> 的支數。
      <span class="hint">若檔案是掃描影像，系統會自動啟用 OCR。</span>
    </p>

    <div class="card row">
      <div>
        <label class="drop" id="drop">
          <input type="file" id="file" accept="application/pdf" />
          <strong>點我選擇 PDF 或拖曳到這裡</strong>
          <div class="small muted">建議 1～10 頁；OCR 會較花時間。</div>
        </label>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="demo">載入示範資料</button>
          <button class="btn" id="csv" disabled>匯出 CSV</button>
          <button class="btn" id="json" disabled>匯出 JSON</button>
        </div>

        <div class="card small" style="margin-top:12px">
          <details open>
            <summary>AA 單價（僅 AA 在「沒有次數」時用金額換算）</summary>
            <div class="muted" style="margin:6px 0 8px">規則：優先讀「補助/自費 後的整數」作支數；只有 AA 找不到次數才用「金額 ÷ 單價」。</div>
            <div class="grid2">
              <label>AA05（元/支）<br><input class="mono" id="p-AA05" type="number" min="1" value="100" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA06（元/支）<br><input class="mono" id="p-AA06" type="number" min="1" value="200" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA09（元/支）<br><input class="mono" id="p-AA09" type="number" min="1" value="770" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA11（元/支）<br><input class="mono" id="p-AA11" type="number" min="1" value="50"  style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
            </div>
          </details>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="small muted">處理進度</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div id="status" class="small muted" style="margin-top:6px">待上傳</div>
        </div>

        <div id="debug" class="small">偵錯訊息：</div>
      </div>

      <div>
        <div class="card">
          <div class="small muted">分析結果</div>
          <h3 style="margin:.2rem 0 8px">BA 統計</h3>
          <table id="t-BA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th><th class="right">平均每筆</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:.2rem 0 8px">AA 統計</h3>
          <table id="t-AA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th><th class="right">平均每筆</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:.2rem 0 8px">GA 統計</h3>
          <table id="t-GA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th><th class="right">平均每筆</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:.2rem 0 8px">SC 統計</h3>
          <table id="t-SC">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th><th class="right">平均每筆</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card small">
      <details>
        <summary>解析規則</summary>
        <ul>
          <li>代碼偵測：<code>(BA|AA|GA|SC)\d{2}(?:-\d+)?</code>（例：BA01、BA05-1）。</li>
          <li>支數＝優先讀「補助 / 自費 後的整數」；若 AA 無次數才用「金額 ÷ 單價」（四捨五入至小數第 3 位）。</li>
          <li>GA/SC 不做金額換算；沒有明確次數則記 0。</li>
          <li>所有處理均於本機瀏覽器完成。</li>
        </ul>
      </details>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const debug = $('#debug');
    const bar = $('#bar');
    const statusEl = $('#status');

    function log(s){ debug.textContent += (typeof s==='string'?s:JSON.stringify(s,null,2)) + '\n'; console.log('[pdf-stat]', s); }
    function whyStr(e){ return (e && (e.message || e.reason || e.type || e.name)) || String(e); }
    function setBar(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

    const fileInput = $('#file');
    const drop = $('#drop');
    const btnDemo = $('#demo');
    const btnCSV = $('#csv');
    const btnJSON = $('#json');

    const tBodies = {
      BA: $('#t-BA tbody'),
      AA: $('#t-AA tbody'),
      GA: $('#t-GA tbody'),
      SC: $('#t-SC tbody'),
    };

    function getAAUnit(){
      return {
        AA05: Number($('#p-AA05').value || 100),
        AA06: Number($('#p-AA06').value || 200),
        AA09: Number($('#p-AA09').value || 770),
        AA11: Number($('#p-AA11').value || 50),
      };
    }

    // —— 使用 pdf.js 擷取文字；失敗則改用 Blob URL 再試
    async function extractPdfText(file){
      await ensurePdfjs();
      const ab = await file.arrayBuffer();
      const blob = new Blob([ab], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);

      const tryWays = [
        {kind:'data', opts:{data: ab}},
        {kind:'url',  opts:{url}}
      ];

      let lastErr=null;
      for (const way of tryWays){
        try{
          const pdf = await pdfjsLib.getDocument(way.opts).promise;
          let texts = [], total = 0;
          for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent({ normalizeWhitespace:true, disableCombineTextItems:false });
            const s = content.items.map(it=>it.str||'').join(' ');
            total += s.length;
            texts.push(s);
            setBar(100 * i / pdf.numPages);
            statusEl.textContent = `PDF 解析中 (${i}/${pdf.numPages}) · pdf.js ${__pdfVersionUsed} · ${way.kind}`;
          }
          URL.revokeObjectURL(url);
          log(`PDF.js 解析（${way.kind}）：頁數 ${pdf.numPages}，總字元 ${total} · 版本 ${__pdfVersionUsed}`);
          if (pdf.numPages>0) log(`預覽：${texts[0].slice(0,200).replace(/\s+/g,' ')}`);
          return { text: texts.join('\n'), charCount: total, pages: pdf.numPages, pdf };
        }catch(e){
          lastErr=e;
          log(`PDF.js 方式「${way.kind}」失敗：`+whyStr(e));
        }
      }
      throw lastErr || new Error('pdf.js all ways failed');
    }

    // —— 回退：pdf 物件轉 Canvas → Tesseract OCR
    async function ocrPdfToText(pdf){
      await ensureTesseract();
      const worker = await Tesseract.createWorker('chi_tra+eng');

      try{
        let all = [];
        const total = pdf.numPages;
        for(let i=1;i<=total;i++){
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2.0 });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d', { willReadFrequently:true });
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({ canvasContext: ctx, viewport }).promise;

          statusEl.textContent = `OCR 執行中（第 ${i}/${total} 頁）…`;
          setBar(100 * (i-1) / total);
          const res = await worker.recognize(canvas, { rectangle: null });
          all.push(res.data.text || '');
          setBar(100 * i / total);
        }
        const text = all.join('\n');
        log(`OCR 完成：總字元 ${text.length}`);
        log(`預覽：${text.slice(0,200).replace(/\s+/g,' ')}`);
        return text;
      } catch(e){
        log('OCR 錯誤：' + whyStr(e));
        throw e;
      } finally {
        await worker.terminate();
      }
    }

    // —— BA／AA／GA／SC 統計
    function analyze(text){
      const units = getAAUnit();
      const fam = {BA:{}, AA:{}, GA:{}, SC:{}};
      const lines = text.split(/\r?\n/);
      const codeRe = /\b(BA|AA|GA|SC)\d{2}(?:-\d+)?\b/g;

      for(const raw of lines){
        const line = raw.trim();
        if (!line) continue;
        const codes = [...line.matchAll(codeRe)];
        if (!codes.length) continue;

        for(const m of codes){
          const fullCode = m[0];
          const head = fullCode.slice(0,2);
          const store = fam[head];

          const start = Math.max(0, m.index - 40);
          const end   = Math.min(line.length, m.index + fullCode.length + 40);
          const windowStr = line.slice(start, end);

          let count = null;
          const countMatch = windowStr.match(/(?:補\s*助|自\s*費)[^0-9]{0,6}([0-9]{1,2})\b/);
          if (countMatch){
            const v = parseInt(countMatch[1],10);
            if (v>=1 && v<=20) count = v;
          }

          let amount = null;
          if (count===null && head==='AA'){
            const mDollar = windowStr.match(/\$\s*([0-9][0-9,]*)/);
            if (mDollar){
              amount = parseInt(mDollar[1].replace(/,/g,''),10);
            }else{
              const nums = (windowStr.match(/\b\d{2,5}\b/g) || []).map(n=>parseInt(n,10));
              if (nums.length) amount = nums[nums.length-1];
            }
          }

          let zhi = 0;
          if (count!==null){
            zhi = count;
          } else if (head==='AA'){
            const unit = units[fullCode] ?? units[fullCode.slice(0,4)];
            if (unit && amount && amount >= Math.floor(unit*0.5)){
              zhi = Math.round((amount/unit)*1000)/1000;
            }
          }

          const rec = store[fullCode] || {occ:0,sum:0};
          rec.occ += 1; rec.sum += zhi;
          store[fullCode] = rec;
        }
      }

      const rows = obj => Object.entries(obj)
        .map(([code,{occ,sum}])=>({code,occ,sum,avg:occ?sum/occ:0}))
        .sort((a,b)=>a.code.localeCompare(b.code));

      return { BA: rows(fam.BA), AA: rows(fam.AA), GA: rows(fam.GA), SC: rows(fam.SC) };
    }

    function renderRows(tbody, rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span class="pill">${r.code}</span></td>
                        <td class="right">${r.occ}</td>
                        <td class="right">${r.sum.toFixed(3)}</td>
                        <td class="right">${r.avg.toFixed(3)}</td>`;
        tbody.appendChild(tr);
      }
    }
    function renderAll(result){
      renderRows(tBodies.BA, result.BA);
      renderRows(tBodies.AA, result.AA);
      renderRows(tBodies.GA, result.GA);
      renderRows(tBodies.SC, result.SC);
    }
    function exportCSV(res){
      const blk = (title, rows)=>{
        let s = `${title}\n碼別,出現筆數,Σ支數,平均每筆\n`;
        rows.forEach(r=>{ s += `${r.code},${r.occ},${r.sum.toFixed(3)},${r.avg.toFixed(3)}\n`; });
        s += '\n'; return s;
      };
      const csv = blk('【BA 統計】',res.BA)+blk('【AA 統計】',res.AA)+blk('【GA 統計】',res.GA)+blk('【SC 統計】',res.SC);
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='pdf-stat-all.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function exportJSON(res){
      const blob = new Blob([JSON.stringify(res,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='pdf-stat-all.json'; a.click(); URL.revokeObjectURL(url);
    }

    let last=null;

    async function handleFile(file){
      debug.textContent = '偵錯訊息：\n';
      setBar(0); statusEl.textContent = '準備解析…';

      // 先用 PDF.js 嘗試
      let pdfResult = null;
      try{
        pdfResult = await extractPdfText(file);
      }catch(e){
        log('PDF.js 解析失敗，改用 OCR。原因：' + whyStr(e));
      }

      let finalText = '';
      if (pdfResult && pdfResult.charCount > 0){
        setBar(100); statusEl.textContent = 'PDF 文字擷取完成';
        finalText = pdfResult.text;
      } else {
        // 需要 pdf 物件才能渲染成圖做 OCR
        let pdfObj = pdfResult?.pdf;
        if (!pdfObj) {
          try{
            await ensurePdfjs();
            const ab = await file.arrayBuffer();
            const blob = new Blob([ab], {type:'application/pdf'});
            // 再嘗試 data 與 url 兩種
            try{
              pdfObj = await pdfjsLib.getDocument({ data: ab }).promise;
            }catch(e1){
              log('建立 pdf 物件（data）失敗：'+whyStr(e1));
              const url = URL.createObjectURL(blob);
              try{
                pdfObj = await pdfjsLib.getDocument({ url }).promise;
              }catch(e2){
                URL.revokeObjectURL(url);
                throw e2;
              }
              URL.revokeObjectURL(url);
            }
          }catch(e){
            log('pdf 物件建立失敗，無法啟用 OCR：'+whyStr(e));
            alert('此 PDF 無法解析（可能損壞或受保護）。可先用 Google 雲端硬碟「以 Google 文件開啟」做一次 OCR 另存再上傳。');
            return;
          }
        }
        statusEl.textContent = '未偵測到文字，啟用 OCR…（首次可能較久）';
        setBar(1);
        finalText = await ocrPdfToText(pdfObj);
        setBar(100); statusEl.textContent = 'OCR 完成';
      }

      if (!finalText.trim()){
        alert('沒有擷取到內容；請檢查檔案是否為空白或嚴重失真。');
        return;
      }

      const result = analyze(finalText);
      renderAll(result);
      last = result;
      btnCSV.disabled = btnJSON.disabled = false;
    }

    // 選檔
    fileInput.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const ok = (f.type==='application/pdf') || /\.pdf$/i.test(f.name);
      if(!ok){ alert('請選擇 PDF 檔'); return; }
      log(`讀取：${f.name} (${f.type||'N/A'}) size=${f.size}`);
      handleFile(f);
    });

    // 拖放
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='#eef4ff';}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='#f9fbff';}));
    drop.addEventListener('drop', e=>{
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!f) return;
      const ok = (f.type==='application/pdf') || /\.pdf$/i.test(f.name);
      if(!ok){ alert('請拖入 PDF 檔案'); return; }
      log(`拖放：${f.name} (${f.type||'N/A'}) size=${f.size}`);
      handleFile(f);
    });

    // 匯出
    btnCSV.addEventListener('click', ()=>{ if(last) exportCSV(last); });
    btnJSON.addEventListener('click', ()=>{ if(last) exportJSON(last); });

    // 示範資料
    btnDemo.addEventListener('click', ()=>{
      const demo = `嚴雅雯 范秉殷 2025-09-05 5 08:07 ~ 08:42 BA01 補助 1 $ 260
嚴雅雯 劉德雄 2025-09-01 1 09:43 ~ 10:03 BA01 補助 1 $ 260
嚴雅雯 賴美女 2025-09-01 1 11:32 ~ 12:04 BA05-1 補助 1 $ 310
嚴雅雯 江昭輝 2025-09-01 1 14:25 ~ 14:51 BA07 補助 1 $ 325
嚴雅雯 賴美女 2025/09/06 AA09 補助 770
嚴雅雯 江昭輝 2025/09/01 AA11 補助 50`;
      const result = analyze(demo);
      renderAll(result);
      last = result;
      btnCSV.disabled = btnJSON.disabled = false;
      setBar(100); statusEl.textContent = '示範資料已載入';
    });
  })();
  </script>
</body>
</html>
