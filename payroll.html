<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è–ªè³‡è¨ˆç®—æ©Ÿï½œé•·ç…§å·¥å…·</title>
  <meta name="description" content="è¼¸å…¥æœ¬æœˆ AA / BA / GA / SC çš„æ”¯æ•¸ï¼Œè¨ˆç¸½é¡ä¸¦ä¾æ¯”ä¾‹æ‹†è–ªï¼›å¯å¾ PDF è‡ªå‹•çµ±è¨ˆä¸¦é¸æ“‡æ˜¯å¦åŒæ­¥ï¼Œå³å´å³æ™‚æ¯”å°å‹å¥ä¿æ‰£æ¬¾ï¼Œå¾—å‡ºå¯¦é ˜ã€‚">
  <link rel="icon" type="image/x-icon" href="YORU.ico" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="topbar-fixed.css" />
  <script src="nav.js" defer></script>
  <style>
    :root{
      --wm-text:"@horiç‰ˆæ¬Šæ‰€æœ‰"; --wm-size:36px; --wm-angle:-25deg; --wm-alpha:.05; --wm-shift:120px;
    }
    .watermark{position:fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden;}
    .wm-item{position:absolute; font-weight:700; font-size:var(--wm-size); color:rgba(0,0,0,var(--wm-alpha));
      transform:rotate(var(--wm-angle)); white-space:nowrap; user-select:none;
      animation:wm-sway var(--dur,12s) ease-in-out infinite alternate;}
    @keyframes wm-sway{0%{transform:translateX(0) rotate(var(--wm-angle));}
      100%{transform:translateX(var(--wm-shift)) rotate(var(--wm-angle));}}
    @media print{.watermark{opacity:.08}}

    /* æœ¬é å°å…ƒä»¶ */
    .kpi{display:flex; gap:16px; flex-wrap:wrap;}
    .kpi .box{flex:1 1 240px; background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px;
      display:flex; flex-direction:column; gap:6px; box-shadow:0 1px 2px rgba(0,0,0,.05);}
    .kpi .box .lbl{color:#7a7557; font-weight:700;}
    .kpi .box .num{font-size:24px; font-weight:900; color:#2e7d32;}
    .tbl{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--line);
      border-radius:12px; overflow:hidden;}
    .tbl th{background:#f6f1d9; color:#5b5534; padding:10px; font-weight:800; border-bottom:1px solid var(--line);}
    .tbl th.month-col{text-align:center;}
    .tbl td{padding:10px; border-top:1px solid var(--line);}
    .tbl tbody tr:nth-child(even){background:#fffef9;}
    .tbl input[type="number"]{width:90px; height:34px; text-align:right;}

    /* æ‰‹æ©Ÿç‰ˆï¼šå¡ç‰‡å¼è¡¨æ ¼ï¼‹è¼¸å…¥æ¡†é å³ */
    @media (max-width:860px){
      .tbl{display:block; font-size:15px; border:0; background:none; overflow:visible;}
      .tbl thead{display:none;}
      .tbl tbody,.tbl tfoot{display:block; width:100%;}
      .tbl tbody tr{display:block; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
        margin-bottom:12px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05);}
      .tbl tbody tr:nth-child(even){background:#fff;}
      .tbl td{display:flex; gap:12px; justify-content:space-between; align-items:center; padding:6px 0; line-height:1.45;
        white-space:normal; border-top:none;}
      .tbl td[data-label]{text-align:left;}
      .tbl td[data-label]::before{content:attr(data-label); font-weight:700; color:#5b5534; flex:1; text-align:left;}
      .tbl td[data-label="ä»£ç¢¼ï¼‹åç¨±"],
      .tbl td[data-label="ä»£ç¢¼"]{flex-direction:column; align-items:flex-start;}
      .tbl td[data-label="ä»£ç¢¼ï¼‹åç¨±"]::before,
      .tbl td[data-label="ä»£ç¢¼"]::before{margin-bottom:2px;}
      .tbl td.right{justify-content:space-between;}

      /* ğŸ”§ æ‰‹æ©Ÿç‰ˆï¼šæ‰€æœ‰ .tbl æ•¸å­—è¼¸å…¥èˆ‡ select éƒ½é å³çš„å°æ¡† */
      .tbl input[type="number"],
      .tbl select{
        width:auto;
        min-width:80px;
        max-width:120px;
        height:32px;
        margin-left:auto;
        margin-right:0;
        text-align:right;
      }

      .tbl td[data-label="è¨­å®š"]{flex-direction:column; align-items:flex-start; gap:6px;}
      .tbl tfoot{border:1px solid var(--line); border-radius:12px; background:#fff; padding:10px 12px;}
      .tbl tfoot tr{display:flex; flex-wrap:wrap; justify-content:flex-end; gap:8px;}
      .tbl tfoot th{flex:1 1 auto; background:none; border:none; padding:0; text-align:right;}
      .tbl tfoot th:last-child{flex:0 0 auto; min-width:90px; font-size:18px;}
    }

    .right{text-align:right;} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    @media (max-width:860px){.grid-2{grid-template-columns:1fr;}}
    .row-mid{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pill-note{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:700; color:#333;}
    .month-col{text-align:center;}

    /* ğŸ”§ æ¡Œæ©Ÿç‰ˆï¼šAA / BA / GA / SC è¡¨é ­ã€Œå–®åƒ¹ï¼æœ¬æœˆæ”¯æ•¸ï¼å°è¨ˆã€ä¸‰æ¬„ç­‰å¯¬ï¼Œå–®åƒ¹å³å°é½Š */
    @media (min-width:861px){
      :is(#tblAA,#tblBA,#tblGA,#tblSC){table-layout:fixed;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) col.col-code{width:40%;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) col.col-price,
      :is(#tblAA,#tblBA,#tblGA,#tblSC) col.col-month,
      :is(#tblAA,#tblBA,#tblGA,#tblSC) col.col-sum{width:20%;}

      /* è¡¨é ­å°é½Šï¼šå–®åƒ¹å³ã€æœ¬æœˆæ”¯æ•¸ä¸­ã€å°è¨ˆå³ */
      :is(#tblAA,#tblBA,#tblGA,#tblSC) thead th:nth-child(2){text-align:right;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) thead th:nth-child(3){text-align:center;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) thead th:nth-child(4){text-align:right;}

      /* æœ¬æœˆæ”¯æ•¸å„²å­˜æ ¼èˆ‡è¼¸å…¥æ¡†ç½®ä¸­ */
      :is(#tblAA,#tblBA,#tblGA,#tblSC) td[data-label="æœ¬æœˆæ”¯æ•¸"]{text-align:center;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) td[data-label="æœ¬æœˆæ”¯æ•¸"] input{margin:0 auto; text-align:center;}
    }

    /* ğŸ”§ æ‰‹æ©Ÿç‰ˆï¼šå››å¼µä¸»è¡¨çš„ã€Œæœ¬æœˆæ”¯æ•¸ã€æ¬„ï¼Œæ¨™ç±¤åœ¨å·¦ã€è¼¸å…¥æ¡†é å³å°æ¡† */
    @media (max-width:860px){
      :is(#tblAA,#tblBA,#tblGA,#tblSC) td[data-label="æœ¬æœˆæ”¯æ•¸"]{align-items:center;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) td[data-label="æœ¬æœˆæ”¯æ•¸"]::before{flex:0 0 auto;}
      :is(#tblAA,#tblBA,#tblGA,#tblSC) td[data-label="æœ¬æœˆæ”¯æ•¸"] input{
        display:block;
        margin-left:auto;
        margin-right:0;
        width:52px;
        height:28px;
        font-size:12px;
        padding:0 4px;
        text-align:right;
      }
    }

    /* PDF æ”¯æ•¸å°å·¥å…·ï¼ˆps- å‰ç¶´ï¼‰ */
    .ps-muted{color:#5b6b81}.ps-small{font-size:.86rem}.ps-mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ps-pill{display:inline-block;padding:0 6px;border:1px solid #dbe6ff;background:#eef4ff;border-radius:999px}
    .ps-grid{display:grid;gap:12px}@media(min-width:920px){.ps-grid{grid-template-columns:1.1fr .9fr}}
    .ps-drop{border:2px dashed #c7d3ee;border-radius:12px;padding:18px;text-align:center;cursor:pointer;background:#f9fbff;display:block}
    .ps-drop:hover{background:#eef4ff}
    .ps-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ps-btn{border:1px solid #c7d3ee;background:#f3f6ff;color:#102a56;padding:8px 12px;border-radius:10px;cursor:pointer}
    .ps-btn:disabled{opacity:.5;cursor:not-allowed}
    .ps-box{background:#fff;border:1px solid #e1e6ef;border-radius:12px;padding:12px;margin-top:10px}
    .ps-progress{height:10px;background:#eef3ff;border-radius:999px;overflow:hidden}
    .ps-bar{height:100%;width:0;background:#2667ff;transition:width .2s}
    .ps-h3{margin:.2rem 0 8px}
    .ps-table{width:100%;border-collapse:collapse}
    .ps-table thead th{background:#eef3ff;color:#102a56;text-align:left;padding:8px;border-bottom:1px solid #d8e2ff}
    .ps-table tbody td{padding:8px;border-bottom:1px solid #edf1f7}
    .ps-table tbody tr:hover{background:#f5f8ff}
    .ps-right{text-align:right}
    .ps-syncbar{border-color:#c7e7c7;background:#f6fff6}
  </style>
</head>
<body data-page="payroll">
  <!-- æµ®æ°´å° -->
  <div class="watermark" aria-hidden="true">
    <span class="wm-item" style="top:5%; left:5%;  --dur:9s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:5%; left:35%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:5%; left:65%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:10%; --dur:13s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:40%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:70%; --dur:14s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:5%;  --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:35%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:65%; --dur:9s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:10%; --dur:13s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:40%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:70%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:15%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:45%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:75%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
  </div>

  <!-- é ‚éƒ¨å°è¦½ -->
  <header class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-link" aria-label="å›é¦–é ">
        <img src="org-logo.png" alt="logo" onerror="this.style.opacity=0.2" />
      </a>
      <span class="site-title" id="siteTitle" data-sync-title>è–ªè³‡è¨ˆç®—æ©Ÿ</span>
    </div>
    <nav class="nav-links" aria-label="ä¸»é¸å–®">
      <a href="index.html">é¡åº¦è¨ˆç®—æ©Ÿ</a>
      <a href="payroll.html">è–ªè³‡è¨ˆç®—æ©Ÿ</a>
      <a href="care-info.html">é•·ç…§ç›¸é—œè³‡è¨Š</a>
      <a href="news.html">æœ€æ–°å…¬å‘Š</a>
      <a href="contact.html">è¯ç¹«æ–¹å¼</a>
      <a href="about.html">é—œæ–¼æˆ‘å€‘</a>
    </nav>
    <div class="actions">
      <button class="btn pill btn-gray" id="btnPrint" type="button">åˆ—å°</button>
      <button class="btn pill btn-green" id="btnResetAll" type="button">å…¨éƒ¨æ¸…ç©º</button>
    </div>
  </header>
  <div class="divider"></div>

  <main class="container">
    <!-- KPI -->
    <section class="card" style="margin-bottom:16px;">
      <h1 class="card-title" style="font-size:22px;">æœ¬æœˆè–ªè³‡ç¸½è¦½</h1>
      <p class="hint">è¼¸å…¥å„ç¢¼åˆ¥æœ¬æœˆæ”¯æ•¸ â†’ è¨ˆç¸½é¡ â†’ ä¾æ¯”ä¾‹æ‹†è–ªï¼›å³å´å³æ™‚æ¯”å°å‹å¥ä¿æ‰£æ¬¾ï¼Œç®—å‡ºã€Œå¯¦é ˜ã€ã€‚</p>
      <div class="kpi" style="margin-top:10px;">
        <div class="box"><div class="lbl">AA å°è¨ˆ</div><div class="num" id="kpiAA">0</div></div>
        <div class="box"><div class="lbl">BA å°è¨ˆ</div><div class="num" id="kpiBA">0</div></div>
        <div class="box"><div class="lbl">GA å°è¨ˆ</div><div class="num" id="kpiGA">0</div></div>
        <div class="box"><div class="lbl">SC å°è¨ˆ</div><div class="num" id="kpiSC">0</div></div>
        <div class="box"><div class="lbl">å…¨æœˆç¸½é¡</div><div class="num" id="kpiTotal">0</div></div>
        <div class="box"><div class="lbl">æ‹†è–ªå¾Œè–ªè³‡</div><div class="num" id="kpiSalary">0</div></div>
        <div class="box"><div class="lbl">å‹å¥ä¿åˆè¨ˆ</div><div class="num" id="kpiIns">0</div></div>
        <div class="box"><div class="lbl">å¯¦é ˜</div><div class="num" id="kpiNet">0</div></div>
      </div>
    </section>

    <!-- æ‹†è–ªæ¯”ä¾‹ -->
    <section class="card">
      <h2 class="card-title">â‘  æ‹†è–ªæ¯”ä¾‹</h2>
      <div class="grid-2" style="margin-top:8px;">
        <div class="row-mid">
          <label style="min-width:120px;font-weight:700;">æ‹†è–ªæ¯”ä¾‹ï¼ˆ%ï¼‰</label>
          <input id="ratioPct" type="number" min="0" max="100" step="0.1" value="60" style="height:34px;width:120px;text-align:right;">
          <span class="hint">ä¾‹ï¼š6/4 â†’ å¡« 60</span>
        </div>
        <div class="row-mid">
          <label style="min-width:120px;font-weight:700;">æœˆä»½</label>
          <input id="plMonth" type="month" style="height:34px;width:180px;">
        </div>
      </div>
    </section>

    <!-- PDF æ”¯æ•¸è‡ªå‹•çµ±è¨ˆ -->
    <section class="card ps-card" id="ps-widget">
      <h2 class="card-title">PDF æ”¯æ•¸è‡ªå‹•çµ±è¨ˆï¼ˆå¸¶å…¥è¡¨å–®ï¼‰</h2>
      <p class="ps-muted">ä¸Šå‚³æ¯æœˆ PDFï¼Œçµ±è¨ˆ <span class="ps-pill">BA</span> / <span class="ps-pill">AA</span> / <span class="ps-pill">GA</span> / <span class="ps-pill">SC</span>ã€‚AA ä»¥ã€Œé‡‘é¡ Ã· å–®åƒ¹ã€æ›ç®—ï¼ˆå››æ¨äº”å…¥åˆ°æœ€æ¥è¿‘ 0.5ï¼‰ï¼ŒAA å–®åƒ¹å›ºå®šã€‚</p>

      <label class="ps-drop" id="ps-drop">
        <input type="file" id="ps-file" accept="application/pdf" />
        <strong>é»æˆ‘é¸æ“‡ PDF æˆ–æ‹–æ›³åˆ°é€™è£¡</strong>
        <div class="ps-small ps-muted">ç„¡æ–‡å­—å±¤å°‡è‡ªå‹• OCRï¼ˆç¹ä¸­ï¼‹è‹±æ–‡ï¼‰ã€‚</div>
      </label>

      <div class="ps-btns">
        <button class="ps-btn" id="ps-demo" type="button">è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
        <button class="ps-btn" id="ps-apply" type="button" disabled>å¸¶å…¥ä¸Šæ–¹è¡¨å–®</button>
        <button class="ps-btn" id="ps-csv" type="button" disabled>åŒ¯å‡º CSV</button>
        <button class="ps-btn" id="ps-json" type="button" disabled>åŒ¯å‡º JSON</button>
      </div>

      <!-- è‡ªå‹•åŒæ­¥é–‹é—œ -->
      <label class="ps-small ps-muted" style="display:inline-flex;align-items:center;gap:6px;margin-top:6px;">
        <input id="ps-auto-sync" type="checkbox"> åŒ¯å…¥å¾Œè‡ªå‹•åŒæ­¥åˆ°ä¸‹æ–¹æ”¯æ•¸
      </label>

      <!-- åŒæ­¥ç¢ºèªæ¢ -->
      <div id="ps-syncbar" class="ps-syncbar ps-box" style="display:none;align-items:center;justify-content:space-between;gap:8px;">
        <div class="ps-small">å·²è§£æå‡ºæ”¯æ•¸ï¼Œè¦åŒæ­¥åˆ°ä¸‹æ–¹è¡¨æ ¼ï¼ˆAA/BA/GA/SCï¼‰ä¸¦ç«‹å³è¨ˆç®—è–ªè³‡å—ï¼Ÿ</div>
        <div style="display:flex;gap:8px;">
          <button id="ps-sync-yes" class="ps-btn">åŒæ­¥</button>
          <button id="ps-sync-no" class="ps-btn" style="background:#fff;">å…ˆä¸è¦</button>
        </div>
      </div>

      <div class="ps-box">
        <div class="ps-small ps-muted">è™•ç†é€²åº¦</div>
        <div class="ps-progress"><div id="ps-bar" class="ps-bar"></div></div>
        <div id="ps-status" class="ps-small ps-muted" style="margin-top:6px">å¾…ä¸Šå‚³</div>
      </div>
      <pre id="ps-debug" class="ps-box ps-small" style="white-space:pre-wrap">åµéŒ¯è¨Šæ¯ï¼š</pre>

      <div style="display:grid;gap:12px;margin-top:10px;">
        <div class="ps-box">
          <h3 class="ps-h3">BA çµ±è¨ˆ</h3>
          <table id="ps-t-BA" class="ps-table">
            <thead><tr><th>ç¢¼åˆ¥</th><th class="ps-right">å‡ºç¾ç­†æ•¸</th><th class="ps-right">Î£ æ”¯æ•¸</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">AA çµ±è¨ˆ</h3>
          <table id="ps-t-AA" class="ps-table">
            <thead><tr><th>ç¢¼åˆ¥</th><th class="ps-right">å‡ºç¾ç­†æ•¸</th><th class="ps-right">Î£ æ”¯æ•¸</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">GA çµ±è¨ˆ</h3>
          <table id="ps-t-GA" class="ps-table">
            <thead><tr><th>ç¢¼åˆ¥</th><th class="ps-right">å‡ºç¾ç­†æ•¸</th><th class="ps-right">Î£ æ”¯æ•¸</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">SC çµ±è¨ˆ</h3>
          <table id="ps-t-SC" class="ps-table">
            <thead><tr><th>ç¢¼åˆ¥</th><th class="ps-right">å‡ºç¾ç­†æ•¸</th><th class="ps-right">Î£ æ”¯æ•¸</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AA -->
    <section class="card">
      <h2 class="card-title">â‘¡ AA æœ¬æœˆæ”¯æ•¸</h2>
      <table class="tbl" id="tblAA">
        <colgroup>
          <col class="col-code">
          <col class="col-price">
          <col class="col-month">
          <col class="col-sum">
        </colgroup>
        <thead><tr><th style="min-width:220px;">ä»£ç¢¼</th><th class="right">å–®åƒ¹</th><th class="month-col">æœ¬æœˆæ”¯æ•¸</th><th class="right">å°è¨ˆ</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">AA å°è¨ˆ</th><th class="right" id="sumAA">0</th></tr></tfoot>
      </table>
      <p class="hint" style="margin-top:8px;">å–®åƒ¹å›ºå®šï¼šAA05 200ã€AA06 200ã€AA07 760ã€AA08 385ã€AA09 770ã€AA11 50ã€‚</p>
    </section>

    <!-- BA -->
    <section class="card">
      <h2 class="card-title">â‘¢ BA æœ¬æœˆæ”¯æ•¸</h2>
      <table class="tbl" id="tblBA">
        <colgroup>
          <col class="col-code">
          <col class="col-price">
          <col class="col-month">
          <col class="col-sum">
        </colgroup>
        <thead><tr><th style="min-width:260px;">ä»£ç¢¼ï¼‹åç¨±</th><th class="right">å–®åƒ¹</th><th class="month-col">æœ¬æœˆæ”¯æ•¸</th><th class="right">å°è¨ˆ</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">BA å°è¨ˆ</th><th class="right" id="sumBA">0</th></tr></tfoot>
      </table>
    </section>

    <!-- GA -->
    <section class="card">
      <h2 class="card-title">â‘£ GA æœ¬æœˆæ”¯æ•¸</h2>
      <table class="tbl" id="tblGA">
        <colgroup>
          <col class="col-code">
          <col class="col-price">
          <col class="col-month">
          <col class="col-sum">
        </colgroup>
        <thead><tr><th style="min-width:220px;">ä»£ç¢¼ï¼‹åç¨±</th><th class="right">å–®åƒ¹</th><th class="month-col">æœ¬æœˆæ”¯æ•¸</th><th class="right">å°è¨ˆ</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">GA å°è¨ˆ</th><th class="right" id="sumGA">0</th></tr></tfoot>
      </table>
    </section>

    <!-- SC -->
    <section class="card">
      <h2 class="card-title">â‘¤ SC æœ¬æœˆæ”¯æ•¸</h2>
      <table class="tbl" id="tblSC">
        <colgroup>
          <col class="col-code">
          <col class="col-price">
          <col class="col-month">
          <col class="col-sum">
        </colgroup>
        <thead><tr><th style="min-width:220px;">ä»£ç¢¼ï¼‹åç¨±</th><th class="right">å–®åƒ¹</th><th class="month-col">æœ¬æœˆæ”¯æ•¸</th><th class="right">å°è¨ˆ</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">SC å°è¨ˆ</th><th class="right" id="sumSC">0</th></tr></tfoot>
      </table>
    </section>

    <!-- çµæœï¼‹å‹å¥ä¿ -->
    <section class="card">
      <h2 class="card-title">â‘¥ è–ªè³‡çµæœ & å‹å¥ä¿æ‰£æ¬¾</h2>
      <div class="grid-2" style="margin-top:8px;">
        <div class="card" style="padding:14px;">
          <table class="tbl">
            <tbody>
              <tr><td>AA å°è¨ˆ</td><td class="right mono" id="resAA">0</td></tr>
              <tr><td>BA å°è¨ˆ</td><td class="right mono" id="resBA">0</td></tr>
              <tr><td>GA å°è¨ˆ</td><td class="right mono" id="resGA">0</td></tr>
              <tr><td>SC å°è¨ˆ</td><td class="right mono" id="resSC">0</td></tr>
              <tr><td><b>å…¨æœˆç¸½é¡ï¼ˆAA+BA+GA+SCï¼‰</b></td><td class="right mono" id="resTotal"><b>0</b></td></tr>
              <tr><td>æ‹†è–ªæ¯”ä¾‹</td><td class="right mono"><span id="resRatio">60</span>%</td></tr>
              <tr><td><b>æ‹†è–ªå¾Œè–ªè³‡</b></td><td class="right mono" id="resSalary"><b>0</b></td></tr>
              <tr><td><b>å¯¦é ˜ï¼ˆæ‰£å‹å¥ä¿ï¼‰</b></td><td class="right mono" id="resNet"><b>0</b></td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="padding:14px;">
          <div class="row-mid" style="margin-bottom:10px;">
            <span class="pill-note">è‡ªå‹•ä¾ã€Œæ‹†è–ªå¾Œè–ªè³‡ã€æŠ“ â‰¥ è–ªè³‡çš„æœ€å¤§æŠ•ä¿ç´šè·</span>
          </div>
          <table class="tbl">
            <thead>
              <tr>
                <th>æŠ•ä¿ç´šè·</th>
                <th class="right">å‹ä¿ï¼ˆå“¡å·¥ï¼‰</th>
                <th class="right">å¥ä¿ï¼ˆå“¡å·¥ï¼‰</th>
                <th class="right">åˆè¨ˆ</th>
                <th style="width:180px;">è¨­å®š</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td data-label="æŠ•ä¿ç´šè·"><select id="insGrade" style="height:34px;min-width:140px;"></select></td>
                <td class="right" data-label="å‹ä¿ï¼ˆå“¡å·¥ï¼‰"><input id="insLabor" type="number" min="0" step="1" value="0" style="height:34px;width:110px;text-align:right;"></td>
                <td class="right" data-label="å¥ä¿ï¼ˆå“¡å·¥ï¼‰"><input id="insHealth" type="number" min="0" step="1" value="0" style="height:34px;width:110px;text-align:right;"></td>
                <td class="right mono" id="insSum" data-label="åˆè¨ˆ">0</td>
                <td data-label="è¨­å®š">
                  <label class="chip" style="cursor:pointer;">
                    <input id="insAuto" type="checkbox" checked> è‡ªå‹•å¸¶å…¥é‡‘é¡
                  </label>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="row-mid" style="margin-top:12px;">
            <div class="pill-note">å¯¦é ˜ï¼ˆæ‹†è–ªå¾Œè–ªè³‡ï¼å‹å¥ä¿åˆè¨ˆï¼‰ï¼š<b class="mono" id="netPay">0</b></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨è³‡è¨Šæ¢ -->
  <footer id="bottomDock" class="footerbar">
    <div class="foot">
      <span class="ok">â€» æ¯å¹´ <b>2 æœˆ</b> å’Œ <b>8 æœˆ</b> èª¿æ•´æŠ•ä¿ç´šè·ï¼Œä¸¦æ–¼æ¬¡æœˆ <b>1 è™Ÿ</b> ç”Ÿæ•ˆã€‚</span>
    </div>
  </footer>

  <!-- ä¸»é‚è¼¯ï¼ˆè¼¸å…¥/è¨ˆç®—/å‹å¥ä¿/å„²å­˜ï¼‰ -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const N = v => (isFinite(+v) ? +v : 0);
      const F = v => new Intl.NumberFormat('zh-Hant-TW', { maximumFractionDigits: 0 }).format(v);

      /* å–®åƒ¹ï¼ˆå›ºå®šï¼Œå« AA07=760ï¼›BA15-1/15-2 åˆ†åˆ—ï¼›GA09/SC09=770ï¼‰ */
      const PRICE = {
        AA: { AA05:200, AA06:200, AA07:760, AA08:385, AA09:770, AA11:50 },
        BA: [
          { code:"BA01", name:"åŸºæœ¬èº«é«”æ¸…æ½”", price:260 },
          { code:"BA02", name:"åŸºæœ¬æ—¥å¸¸ç…§é¡§", price:195 },
          { code:"BA03", name:"æ¸¬é‡ç”Ÿå‘½å¾µè±¡", price:35 },
          { code:"BA04", name:"å”åŠ©é€²é£Ÿæˆ–ç®¡çŒ", price:130 },
          { code:"BA05", name:"é¤é£Ÿç…§é¡§", price:310 },
          { code:"BA07", name:"å”åŠ©æ²æµ´åŠæ´—é ­", price:325 },
          { code:"BA08", name:"è¶³éƒ¨ç…§è­·", price:500 },
          { code:"BA10", name:"ç¿»èº«æ‹èƒŒ", price:155 },
          { code:"BA11", name:"è‚¢é«”é—œç¯€æ´»å‹•", price:195 },
          { code:"BA12", name:"å”åŠ©ä¸Šä¸‹æ¨“æ¢¯", price:130 },
          { code:"BA13", name:"é™ªåŒå¤–å‡º", price:195 },
          { code:"BA14", name:"é™ªåŒå°±é†«", price:685 },
          { code:"BA15-1", name:"å®¶å‹™å”åŠ©-1", price:195 },
          { code:"BA15-2", name:"å®¶å‹™å”åŠ©-2", price:195 },
          { code:"BA16", name:"ä»£è³¼", price:130 },
          { code:"BA17a", name:"äººå·¥æ°£é“ç®¡æŠ½å¸", price:75 },
          { code:"BA17b", name:"å£è…”å…§æŠ½å¸", price:65 },
          { code:"BA17c", name:"ç®¡è·¯æ¸…æ½”", price:50 },
          { code:"BA17d", name:"é€šä¾¿/é©—è¡€ç³–", price:50 },
          { code:"BA17e", name:"ä¾æŒ‡ç¤ºç½®å…¥è—¥ç›’", price:50 },
          { code:"BA18", name:"å®‰å…¨çœ‹è¦–", price:200 },
          { code:"BA20", name:"é™ªä¼´æœå‹™", price:175 },
          { code:"BA22", name:"å·¡è¦–æœå‹™", price:130 },
          { code:"BA23", name:"å”åŠ©æ´—é ­", price:200 },
          { code:"BA24", name:"å”åŠ©æ’æ³„", price:220 }
        ],
        GA: [{ code:"GA09", name:"å–˜æ¯ 2 å°æ™‚/æ”¯", price:770 }],
        SC: [{ code:"SC09", name:"çŸ­ç…§ 2 å°æ™‚/æ”¯", price:770 }]
      };

      /* å‹å¥ä¿ç´šè·è¡¨ï¼ˆå“¡å·¥è‡ªä»˜ï¼‰ */
      const INS_TABLE = [
        { grade:11100, labor:277, health:443 }, { grade:12540, labor:313, health:443 },
        { grade:13500, labor:338, health:443 }, { grade:15840, labor:396, health:443 },
        { grade:16500, labor:413, health:443 }, { grade:17280, labor:432, health:443 },
        { grade:19047, labor:476, health:443 }, { grade:20008, labor:505, health:443 },
        { grade:21009, labor:525, health:443 }, { grade:22000, labor:550, health:443 },
        { grade:23100, labor:577, health:443 }, { grade:24000, labor:600, health:443 },
        { grade:25250, labor:632, health:443 }, { grade:26400, labor:660, health:443 },
        { grade:27600, labor:690, health:443 }, { grade:28590, labor:715, health:443 },
        { grade:28800, labor:720, health:447 }, { grade:30300, labor:758, health:472 },
        { grade:31800, labor:795, health:493 }, { grade:33300, labor:833, health:516 },
        { grade:34800, labor:870, health:540 }, { grade:36300, labor:908, health:563 },
        { grade:38200, labor:955, health:592 }, { grade:40100, labor:1002, health:622 },
        { grade:41900, labor:1045, health:651 }, { grade:43900, labor:1098, health:681 },
        { grade:45800, labor:1145, health:710 }, { grade:50600, labor:1145, health:785 },
        { grade:53000, labor:1145, health:822 }, { grade:55400, labor:1145, health:859 },
        { grade:57800, labor:1145, health:896 }, { grade:60800, labor:1145, health:943 },
        { grade:63800, labor:1145, health:990 }, { grade:66800, labor:1145, health:1036 },
        { grade:69800, labor:1145, health:1083 }, { grade:72800, labor:1145, health:1129 },
        { grade:76500, labor:1145, health:1187 }, { grade:80200, labor:1145, health:1244 },
        { grade:83900, labor:1145, health:1301 }, { grade:87600, labor:1145, health:1359 },
        { grade:92100, labor:1145, health:1428 }, { grade:96600, labor:1145, health:1498 },
        { grade:101100, labor:1145, health:1568 }, { grade:105600, labor:1145, health:1638 },
        { grade:110100, labor:1145, health:1708 }, { grade:115500, labor:1145, health:1791 },
        { grade:120900, labor:1145, health:1875 }, { grade:126300, labor:1145, health:1959 },
        { grade:131700, labor:1145, health:2043 }, { grade:137100, labor:1145, health:2126 },
        { grade:142500, labor:1145, health:2210 }, { grade:147900, labor:1145, health:2294 },
        { grade:150000, labor:1145, health:2327 }
      ];

      /* å»ºè¡¨ï¼ˆè¼¸å…¥ï¼‰ */
      function buildAA(){
        const host = document.querySelector('#tblAA tbody');
        host.innerHTML = '';
        const saved = loadLS('pl-aa', {});
        Object.keys(PRICE.AA).forEach(code=>{
          const price = PRICE.AA[code];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="ä»£ç¢¼">${code}</td>
            <td class="right mono" data-label="å–®åƒ¹">${F(price)}</td>
            <td data-label="æœ¬æœˆæ”¯æ•¸"><input type="number" min="0" step="1" value="${N(saved[code]||0)}" data-aa="${code}"></td>
            <td class="right mono" data-label="å°è¨ˆ" data-aa-sum="${code}">0</td>
          `;
          host.appendChild(tr);
        });
      }
      function buildGroup(tableId, key, savedKey){
        const host = document.querySelector(`#${tableId} tbody`);
        host.innerHTML = '';
        const saved = loadLS(savedKey, {});
        const k = key.toLowerCase();
        PRICE[key].forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="ä»£ç¢¼ï¼‹åç¨±">${item.code}${item.name ? ' ' + item.name : ''}</td>
            <td class="right mono" data-label="å–®åƒ¹">${F(item.price)}</td>
            <td data-label="æœ¬æœˆæ”¯æ•¸"><input type="number" min="0" step="1" value="${N(saved[item.code]||0)}" data-${k}="${item.code}"></td>
            <td class="right mono" data-label="å°è¨ˆ" data-${k}-sum="${item.code}">0</td>
          `;
          host.appendChild(tr);
        });
      }

      /* è¨ˆç®— */
      function calcAA(){
        let total = 0;
        Object.keys(PRICE.AA).forEach(code=>{
          const qty = N(document.querySelector(`input[data-aa="${code}"]`)?.value);
          const sub = qty * PRICE.AA[code];
          document.querySelector(`td[data-aa-sum="${code}"]`).textContent = F(sub);
          total += sub;
        });
        document.querySelector('#sumAA').textContent = F(total);
        document.querySelector('#kpiAA').textContent = F(total);
        document.querySelector('#resAA').textContent = F(total);
        return total;
      }
      function calcGroup(key, sumId, kpiId, resId){
        let total = 0;
        const k = key.toLowerCase();
        PRICE[key].forEach(item=>{
          const qty = N(document.querySelector(`input[data-${k}="${item.code}"]`)?.value);
          const sub = qty * item.price;
          document.querySelector(`td[data-${k}-sum="${item.code}"]`).textContent = F(sub);
          total += sub;
        });
        document.querySelector(sumId).textContent = F(total);
        document.querySelector(kpiId).textContent = F(total);
        document.querySelector(resId).textContent = F(total);
        return total;
      }
      function updateAll(){
        const sumAA = calcAA();
        const sumBA = calcGroup('BA', '#sumBA', '#kpiBA', '#resBA');
        const sumGA = calcGroup('GA', '#sumGA', '#kpiGA', '#resGA');
        const sumSC = calcGroup('SC', '#sumSC', '#kpiSC', '#resSC');
        const total = sumAA + sumBA + sumGA + sumSC;
        $('#kpiTotal').textContent = F(total);
        $('#resTotal').textContent = F(total);
        const ratioPct = N($('#ratioPct').value) || 0;
        const ratio = ratioPct / 100;
        $('#resRatio').textContent = ratioPct;
        const salary = Math.round(total * ratio);
        $('#kpiSalary').textContent = F(salary);
        $('#resSalary').textContent = F(salary);
        syncInsuranceBySalary(salary);
        saveAll();
      }

      /* å‹å¥ä¿ */
      function buildInsOptions(){
        const sel = $('#insGrade'); sel.innerHTML = '';
        INS_TABLE.forEach(row=>{
          const opt = document.createElement('option');
          opt.value = row.grade;
          opt.textContent = row.grade.toLocaleString('zh-TW');
          sel.appendChild(opt);
        });
      }
function findGradeBySalary(sal){
  const list = INS_TABLE.map(r=>r.grade).sort((a,b)=>a-b);
  for (const v of list){
    if (sal <= v) return v;  // æ‰¾åˆ°ç¬¬ä¸€å€‹ã€Œå¤§æ–¼ç­‰æ–¼è–ªè³‡ã€çš„ç´šè·
  }
  return list[list.length-1]; // è¶…éæœ€é«˜ç´šè·æ™‚ç”¨æœ€å¾Œä¸€ç´š
}
      function getRow(grade){
        return INS_TABLE.find(r=>r.grade===grade) || INS_TABLE[0];
      }
      function syncInsuranceBySalary(salary){
        const auto = $('#insAuto').checked;
        const sel = $('#insGrade');
        const autoGrade = findGradeBySalary(salary);
        if (auto && +sel.value!==autoGrade) sel.value = String(autoGrade);
        const row = getRow(+sel.value || autoGrade);
        if (auto){
          $('#insLabor').value = row.labor;
          $('#insHealth').value = row.health;
        }
        const insSum = (+$('#insLabor').value||0) + (+$('#insHealth').value||0);
        $('#insSum').textContent = F(insSum);
        $('#kpiIns').textContent = F(insSum);
        const net = Math.max(0, (salary - insSum));
        $('#netPay').textContent = F(net);
        $('#kpiNet').textContent = F(net);
        $('#resNet').textContent = F(net);
      }

      /* å„²å­˜ï¼é‚„åŸ */
      function saveAll(){
        const aa = {};
        Object.keys(PRICE.AA).forEach(code=> aa[code]=+(document.querySelector(`input[data-aa="${code}"]`).value||0));
        localStorage.setItem('pl-aa', JSON.stringify(aa));
        ['BA','GA','SC'].forEach(key=>{
          const k = key.toLowerCase();
          const obj={};
          PRICE[key].forEach(item=> obj[item.code]=+(document.querySelector(`input[data-${k}="${item.code}"]`).value||0));
          localStorage.setItem(`pl-${k}`, JSON.stringify(obj));
        });
        const params = {
          month: $('#plMonth').value || '',
          ratio: +($('#ratioPct').value) || 0,
          insGrade: +($('#insGrade').value) || 0,
          insLabor: +($('#insLabor').value) || 0,
          insHealth: +($('#insHealth').value) || 0,
          insAuto: $('#insAuto').checked ? 1 : 0
        };
        localStorage.setItem('pl-params', JSON.stringify(params));
      }
      function loadLS(key, fb){ try{ return JSON.parse(localStorage.getItem(key)||'') || fb; }catch(e){ return fb; } }
      function restore(){
        const p = loadLS('pl-params', null);
        if (p){
          if (p.month) $('#plMonth').value = p.month;
          if (p.ratio!=null) $('#ratioPct').value = p.ratio;
          if (p.insGrade) $('#insGrade').value = p.insGrade;
          if (p.insLabor!=null) $('#insLabor').value = p.insLabor;
          if (p.insHealth!=null) $('#insHealth').value = p.insHealth;
          $('#insAuto').checked = !!p.insAuto;
        }
      }

      /* äº‹ä»¶ */
      function wire(){
        ['#tblAA','#tblBA','#tblGA','#tblSC'].forEach(id=>{
          document.querySelectorAll(`${id} input[type="number"]`).forEach(inp=>{
            inp.addEventListener('input', updateAll);
          });
        });
        $('#ratioPct').addEventListener('input', updateAll);
        $('#plMonth').addEventListener('change', saveAll);

        // å‹å¥ä¿äº‹ä»¶
        $('#insGrade').addEventListener('change', ()=>{
          if ($('#insAuto').checked){
            const row = getRow(+$('#insGrade').value);
            $('#insLabor').value = row.labor;
            $('#insHealth').value = row.health;
          }
          syncInsuranceBySalary(+($('#resSalary').textContent||'').replace(/,/g,''));
          saveAll();
        });
        $('#insLabor').addEventListener('input', ()=>{
          $('#insAuto').checked = false;
          syncInsuranceBySalary(+($('#resSalary').textContent||'').replace(/,/g,''));
          saveAll();
        });
        $('#insHealth').addEventListener('input', ()=>{
          $('#insAuto').checked = false;
          syncInsuranceBySalary(+($('#resSalary').textContent||'').replace(/,/g,''));
          saveAll();
        });
        $('#insAuto').addEventListener('change', ()=>{
          syncInsuranceBySalary(+($('#resSalary').textContent||'').replace(/,/g,''));
          saveAll();
        });

        // å³ä¸Šè§’æŒ‰éˆ•
        $('#btnPrint').addEventListener('click', ()=>window.print());
        $('#btnResetAll').addEventListener('click', ()=>{
          ['pl-aa','pl-ba','pl-ga','pl-sc','pl-params'].forEach(k=>localStorage.removeItem(k));
          location.reload();
        });
      }

      /* å•Ÿå‹• */
      buildAA();
      buildGroup('tblBA','BA','pl-ba');
      buildGroup('tblGA','GA','pl-ga');
      buildGroup('tblSC','SC','pl-sc');
      buildInsOptions();
      restore();
      wire();
      updateAll();

      // é˜²æ‹·
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && ['u','s','p'].includes(e.key.toLowerCase())) e.preventDefault();
        if (e.key === 'F12') e.preventDefault();
      });
      document.addEventListener('selectstart', e => e.preventDefault());
      document.addEventListener('copy', e => e.preventDefault());
    })();
  </script>

  <!-- PDF è§£æ + å¸¶å…¥è¡¨å–®ï¼ˆå« OCR å¾Œæ´ï¼›åŒæ­¥å‰æ¸…ç©ºï¼›AA 0.5 é€²ä½ï¼›BA05-1=BA05ï¼›BA16-1/-2=BA16ï¼‰ -->
  <script>
    (() => {
      const $ = s => document.querySelector(s);
      const debug = $('#ps-debug'), bar = $('#ps-bar'), statusEl = $('#ps-status');
      const log = s => { if(!debug) return; debug.textContent += (typeof s==='string'?s:JSON.stringify(s,null,2))+'\n'; };
      const why = e => (e&&(e.message||e.reason||e.type||e.name))||String(e);
      const setBar = p => { if(bar) bar.style.width = Math.max(0,Math.min(100,p))+'%'; };

      // ä»£ç¢¼åˆ¥åï¼ˆåŒç¢¼åˆä½µï¼‰
      const CODE_ALIAS = {
        'BA05-1': 'BA05', 'BA05-2': 'BA05',
        'BA16-1': 'BA16', 'BA16-2': 'BA16'
      };
      const toCanon = c => CODE_ALIAS[c] || c;

      // å‹•æ…‹è¼‰å…¥ pdf.js
      let pdfReady=null, pdfVer=null;
      const loadScript = src => new Promise((res,rej)=>{const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);});
      async function ensurePdfjs(){
        if (window.pdfjsLib) return;
        if (pdfReady){ await pdfReady; return; }
        pdfReady = (async ()=>{
          for (const v of ["4.2.67","3.11.174","2.16.105"]){
            try{
              await loadScript(`https://cdn.jsdelivr.net/npm/pdfjs-dist@${v}/build/pdf.min.js`);
              pdfVer=v;
              try{
                pdfjsLib.GlobalWorkerOptions.workerSrc=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${v}/build/pdf.worker.min.js`;
                await pdfjsLib.getDocument({data:new Uint8Array([0x25,0x50,0x44,0x46])}).promise.catch(()=>null);
              }catch{
                pdfjsLib.GlobalWorkerOptions.workerSrc=""; pdfjsLib.GlobalWorkerOptions.workerPort=null;
              }
              return;
            }catch{}
          }
          throw new Error('pdf.js load failed');
        })();
        await pdfReady;
      }

      // Tesseractï¼ˆOCRï¼‰
      let ocrReady=null;
      async function ensureTesseract(){
        if (window.Tesseract) return;
        if (ocrReady){ await ocrReady; return; }
        ocrReady = (async ()=>{
          await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js');
          Tesseract.setLogging(false);
        })();
        await ocrReady;
      }

      // AA å–®åƒ¹ï¼ˆå« AA07ï¼‰
      function getAAUnit(){ return { AA05:200, AA06:200, AA07:760, AA08:385, AA09:770, AA11:50 }; }

      // è®€ PDF â†’ æ–‡å­—
      async function extractPdfText(file){
        await ensurePdfjs();
        const ab=await file.arrayBuffer();
        const blob=new Blob([ab],{type:'application/pdf'}), url=URL.createObjectURL(blob);
        for (const w of [{k:'data',o:{data:ab}}, {k:'url',o:{url}}]){
          try{
            const pdf=await pdfjsLib.getDocument(w.o).promise;
            let texts=[],total=0;
            for(let i=1;i<=pdf.numPages;i++){
              const page=await pdf.getPage(i);
              const c=await page.getTextContent({normalizeWhitespace:true,disableCombineTextItems:false});
              const s=c.items.map(it=>it.str||'').join(' ');
              texts.push(s); total+=s.length;
              setBar(100*i/pdf.numPages);
              if(statusEl) statusEl.textContent=`PDF è§£æä¸­ (${i}/${pdf.numPages}) Â· ${pdfVer||'pdf.js'}/${w.k}`;
            }
            URL.revokeObjectURL(url);
            log(`PDF.js æˆåŠŸï¼šé =${texts.length} å­—=${total}`);
            return {text:texts.join('\n'), pdf, charCount:total};
          }catch(e){ log(`PDF.js å¤±æ•—(${w.k})ï¼š`+why(e)); }
        }
        throw new Error('pdf.js failed');
      }

      // OCR å›é€€
      async function ocrPdfToText(pdf){
        await ensureTesseract();
        const worker=await Tesseract.createWorker('chi_tra+eng');
        let all=[];
        for(let i=1;i<=pdf.numPages;i++){
          const p=await pdf.getPage(i), v=p.getViewport({scale:2});
          const cvs=document.createElement('canvas'), ctx=cvs.getContext('2d',{willReadFrequently:true});
          cvs.width=v.width; cvs.height=v.height;
          await p.render({canvasContext:ctx,viewport:v}).promise;
          if(statusEl) statusEl.textContent=`OCR åŸ·è¡Œä¸­ï¼ˆ${i}/${pdf.numPages}ï¼‰`;
          const r=await worker.recognize(cvs);
          all.push(r.data.text||'');
          setBar(100*i/pdf.numPages);
        }
        await worker.terminate();
        const t=all.join('\n');
        log(`OCR å®Œæˆï¼šå­—=${t.length}`);
        return t;
      }

      // è§£æè¦å‰‡ï¼ˆæ”¯æ´ -1/-2 å°¾ç¢¼ï¼›AA ä»¥é‡‘é¡/å–®åƒ¹ â†’ 0.5 é€²ä½ï¼›å«åˆ¥ååˆä½µï¼‰
      function analyze(text){
        const units=getAAUnit(), fam={BA:{},AA:{},GA:{},SC:{}};
        const codeRe=/\b(BA|AA|GA|SC)\d{2}(?:-\d+)?\b/g, toHalf=v=>Math.round(v*2)/2;
        for (const raw of text.split(/\r?\n/)){
          const line=raw.trim(); if(!line) continue;
          const codes=[...line.matchAll(codeRe)]; if(!codes.length) continue;
          for (const m of codes){
            const fullRaw=m[0];
            const canon = toCanon(fullRaw); // å…ˆè½‰æ­£è¦ç¢¼
            const head = canon.slice(0,2);
            if (head==='AA'){
              const after=line.slice(m.index+fullRaw.length, m.index+fullRaw.length+40);
              let amt=null, m1=after.match(/\$\s*([0-9][0-9,]*)/);
              if (m1) amt=parseInt(m1[1].replace(/,/g,''),10);
              else {
                const m2=after.match(/\b([0-9]{2,6})\b/);
                if(m2) amt=parseInt(m2[1],10);
              }
              const unit=units[canon]??units[canon.slice(0,4)];
              const zhi = (unit && amt) ? toHalf(amt/unit) : 0;
              const rec=fam.AA[canon]||{occ:0,sum:0};
              rec.occ++; rec.sum+=zhi;
              fam.AA[canon]=rec;
            }else{
              const ctx=line.slice(Math.max(0,m.index-40), Math.min(line.length,m.index+fullRaw.length+40));
              const c=ctx.match(/(?:è£œ\s*åŠ©|è‡ª\s*è²»)[^0-9]{0,6}([0-9]{1,2})\b/);
              const zhi = c ? Math.max(0, Math.min(20, parseInt(c[1],10))) : 0;
              const rec=(fam[head][canon]||{occ:0,sum:0});
              rec.occ++; rec.sum+=zhi;
              fam[head][canon]=rec;
            }
          }
        }
        const rows=obj=>Object.entries(obj).map(([code,{occ,sum}])=>({code,occ,sum})).sort((a,b)=>a.code.localeCompare(b.code));
        return {BA:rows(fam.BA),AA:rows(fam.AA),GA:rows(fam.GA),SC:rows(fam.SC)};
      }

      // æ¸²æŸ“ & åŒ¯å‡º
      const tb={BA:$('#ps-t-BA tbody'),AA:$('#ps-t-AA tbody'),GA:$('#ps-t-GA tbody'),SC:$('#ps-t-SC tbody')};
      const fmtCount = v => Math.round(Number(v) || 0);
      function renderRows(tbody, rows){
        if(!tbody) return;
        tbody.innerHTML='';
        for(const r of rows){
          const sum = fmtCount(r.sum);
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><span class="ps-pill">${r.code}</span></td>
            <td class="ps-right">${r.occ}</td>
            <td class="ps-right">${sum}</td>
          `;
          tbody.appendChild(tr);
        }
      }
      function renderAll(res){ renderRows(tb.BA,res.BA); renderRows(tb.AA,res.AA); renderRows(tb.GA,res.GA); renderRows(tb.SC,res.SC); }
      function exportCSV(res){
        const blk=(t,rows)=>`${t}\nç¢¼åˆ¥,å‡ºç¾ç­†æ•¸,Î£æ”¯æ•¸\n`+rows.map(r=>`${r.code},${r.occ},${fmtCount(r.sum)}`).join('\n')+'\n\n';
        const csv=blk('ã€BAã€‘',res.BA)+blk('ã€AAã€‘',res.AA)+blk('ã€GAã€‘',res.GA)+blk('ã€SCã€‘',res.SC);
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}), url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='pdf-stat.csv'; a.click(); URL.revokeObjectURL(url);
      }
      function exportJSON(res){
        const pick=rows=>rows.map(r=>({code:r.code,occ:r.occ,sum:fmtCount(r.sum)}));
        const payload={BA:pick(res.BA),AA:pick(res.AA),GA:pick(res.GA),SC:pick(res.SC),meta:{generatedAt:new Date().toISOString()}};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}), url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='pdf-stat.json'; a.click(); URL.revokeObjectURL(url);
      }

      // åŒæ­¥åˆ°è¡¨å–®ï¼ˆå…ˆæ¸…ç©º â†’ å†å¯«å…¥ï¼›AA ç”¨ 0.5 stepï¼›BA/GA/SC å–æ•´ï¼‰
      function resetPayrollInputs(){
        document.querySelectorAll('#tblAA input[type="number"][data-aa], #tblBA input[type="number"][data-ba], #tblGA input[type="number"][data-ga], #tblSC input[type="number"][data-sc]')
          .forEach(inp=>{
            inp.value = '0';
            inp.dispatchEvent(new Event('input',{bubbles:true}));
          });
      }
      const fwMap = {'ï¼':'0','ï¼‘':'1','ï¼’':'2','ï¼“':'3','ï¼”':'4','ï¼•':'5','ï¼–':'6','ï¼—':'7','ï¼˜':'8','ï¼™':'9','ï¼':'-','ã€€':' '};
      function normalize(code){ return String(code||'').trim().replace(/[ï¼-ï¼™ï¼ã€€]/g, ch=>fwMap[ch] ?? ch); }
      function setInputByCode(kind, code, val, step){
        const norm = normalize(code);
        const canon = toCanon(norm);
        const sel = document.querySelector(`input[data-${kind}="${canon}"]`);
        if (!sel) return false;
        if (step) sel.setAttribute('step', step);
        sel.value = String(val);
        sel.dispatchEvent(new Event('input',{bubbles:true}));
        return true;
      }
      function applyToPayroll(res){
        resetPayrollInputs();
        const miss = [];
        // AAï¼š0.5 é€²ä½
        res.AA.forEach(r=>{
          const ok = setInputByCode('aa', r.code, r.sum, '0.5');
          if (!ok) miss.push(`AAï¼š${normalize(r.code)}`);
        });
        // BA / GA / SCï¼šæ•´æ•¸
        res.BA.forEach(r=>{
          const ok = setInputByCode('ba', r.code, Math.round(r.sum));
          if (!ok) miss.push(`BAï¼š${normalize(r.code)}`);
        });
        res.GA.forEach(r=>{
          const ok = setInputByCode('ga', r.code, Math.round(r.sum));
          if (!ok) miss.push(`GAï¼š${normalize(r.code)}`);
        });
        res.SC.forEach(r=>{
          const ok = setInputByCode('sc', r.code, Math.round(r.sum));
          if (!ok) miss.push(`SCï¼š${normalize(r.code)}`);
        });

        let warn = document.getElementById('ps-miss');
        const host = document.querySelector('#ps-widget');
        if (miss.length){
          if (!warn){
            warn = document.createElement('div');
            warn.id = 'ps-miss';
            warn.style.cssText = 'margin-top:8px;border:1px dashed #f0b429;background:#fff8e6;border-radius:8px;padding:8px 10px';
            warn.className = 'ps-small';
            host.appendChild(warn);
          }
          warn.innerHTML = `<b>æœªåŒæ­¥çš„ç¢¼åˆ¥ï¼ˆè–ªè³‡è¡¨ä¸­æ²’æœ‰ï¼‰ï¼š</b><br>${miss.map(m=>'â€¢ '+m).join('<br>')}`;
        }else if (warn){ warn.remove(); }

        document.getElementById('tblAA')?.scrollIntoView({behavior:'smooth', block:'start'});
      }

      // è‡ªå‹•/ç¢ºèªåŒæ­¥
      const autoSyncEl = document.getElementById('ps-auto-sync');
      const syncBar = document.getElementById('ps-syncbar');
      const syncYesBtn = document.getElementById('ps-sync-yes');
      const syncNoBtn = document.getElementById('ps-sync-no');
      const AUTO_KEY = 'ps-auto-sync';
      function loadAutoSync(){ try{ return localStorage.getItem(AUTO_KEY)==='1'; }catch(e){ return false; } }
      function saveAutoSync(v){ try{ localStorage.setItem(AUTO_KEY, v?'1':'0'); }catch(e){} }
      function showSyncBar(on){ if(syncBar) syncBar.style.display = on ? 'flex' : 'none'; }
      if (autoSyncEl){ autoSyncEl.checked = loadAutoSync(); autoSyncEl.addEventListener('change', ()=>saveAutoSync(autoSyncEl.checked)); }
      if (syncYesBtn){ syncYesBtn.addEventListener('click', ()=>{ if (last){ applyToPayroll(last); } showSyncBar(false); }); }
      if (syncNoBtn){ syncNoBtn.addEventListener('click', ()=> showSyncBar(false)); }

      // ç¶å®š
      let last=null;
      async function handleFile(f){
        if(!debug) return; debug.textContent='åµéŒ¯è¨Šæ¯ï¼š\n';
        setBar(0); if(statusEl) statusEl.textContent='æº–å‚™è§£æâ€¦';
        let pdfRes=null, text='';
        try{ pdfRes=await extractPdfText(f); }catch(e){ log('PDF.js è§£æå¤±æ•—ï¼Œæ”¹ç”¨ OCRï¼š'+why(e)); }
        if(pdfRes && pdfRes.charCount>0){
          text=pdfRes.text; setBar(100);
          if(statusEl) statusEl.textContent='PDF æ–‡å­—æ“·å–å®Œæˆ';
        } else {
          try{
            const pdf= pdfRes?.pdf || await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;
            if(statusEl) statusEl.textContent='å•Ÿç”¨ OCRâ€¦'; setBar(1);
            text=await ocrPdfToText(pdf); setBar(100);
            if(statusEl) statusEl.textContent='OCR å®Œæˆ';
          }catch(e){ log('OCR ä¹Ÿå¤±æ•—ï¼š'+why(e)); alert('æ­¤ PDF ç„¡æ³•è§£æï¼Œå¯èƒ½æ˜¯åŠ å¯†æˆ–æå£ã€‚'); return; }
        }
        const res=analyze(text);
        renderAll(res);
        last=res;
        document.getElementById('ps-apply').disabled=false;
        document.getElementById('ps-csv').disabled=false;
        document.getElementById('ps-json').disabled=false;
        if (autoSyncEl && autoSyncEl.checked){ applyToPayroll(last); showSyncBar(false); } else { showSyncBar(true); }
      }

      const fileInput=$('#ps-file'), drop=$('#ps-drop');
      if(fileInput){ fileInput.addEventListener('change',e=>{const f=e.target.files?.[0]; if(f) handleFile(f);}); }
      if(drop){
        ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.background='#eef4ff';}));
        ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.style.background='#f9fbff';}));
        drop.addEventListener('drop',e=>{e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);});
      }
      document.getElementById('ps-csv').addEventListener('click',()=>last&&exportCSV(last));
      document.getElementById('ps-json').addEventListener('click',()=>last&&exportJSON(last));
      document.getElementById('ps-apply').addEventListener('click',()=> last && applyToPayroll(last));
      document.getElementById('ps-demo').addEventListener('click',()=>{
        const d=`åš´Xé›¯ è³´Xå¥³ 2025/09/01 AA05 è£œåŠ© $100
åš´Xé›¯ è³´Xå¥³ 2025/09/02 AA05 è£œåŠ© $200
åš´Xé›¯ å¼µXé€² 2025/09/02 AA06 è‡ªè²» $200
åš´Xé›¯ ç‹Xæ˜ 2025/09/03 AA07 è£œåŠ© $760
åš´Xé›¯ OOå…ˆç”Ÿ 2025/09/03 AA08 è‡ªè²» $385
åš´Xé›¯ è³´Xå¥³ 2025/09/06 AA09 è£œåŠ© $770
åš´Xé›¯ æ±ŸXè¼ 2025/09/01 AA11 è£œåŠ© $50
åš´Xé›¯ èŒƒXæ®· 2025-09-05 BA01 è£œåŠ© 1 $260
åš´Xé›¯ æ±ŸXè¼ 2025-09-01 BA07 è£œåŠ© 1 $325
åš´Xé›¯ å¼µXé€² 2025-09-02 BA11 è‡ªè²» 2 $195
åš´Xé›¯ ç‹Xç¾ 2025-09-10 BA15-1 è£œåŠ© 1 $195
åš´Xé›¯ ç‹Xç¾ 2025-09-11 BA05-1 è£œåŠ© 2 $310
åš´Xé›¯ ç‹Xç¾ 2025-09-12 BA15-2 è£œåŠ© 1 $195
åš´Xé›¯ æOO 2025-09-03 GA09 è£œåŠ© 3
åš´Xé›¯ ç‹OO 2025-09-04 SC09 è‡ªè²» 1`;
        const r=analyze(d); renderAll(r); last=r; setBar(100);
        if(statusEl) statusEl.textContent='ç¤ºç¯„è³‡æ–™å·²è¼‰å…¥';
        document.getElementById('ps-apply').disabled=false;
        document.getElementById('ps-csv').disabled=false;
        document.getElementById('ps-json').disabled=false;
        if (autoSyncEl && autoSyncEl.checked){ applyToPayroll(last); showSyncBar(false); } else { showSyncBar(true); }
      });
    })();
  </script>
</body>
</html>
